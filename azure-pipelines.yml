stages:
  - stage: test
    displayName: Build & Test

    jobs:
      - job: MSYS2MinGW
        pool:
          vmImage: "windows-latest"
        variables:
          MSYS2_CACHE: C:\tools\msys64
          MSYS_BIN: C:\tools\msys64\usr\bin
          CHOCO_CACHE: C:\ProgramData\chocolatey
        steps:
          - checkout: self
            fetchDepth: 5
            submodules: recursive
          - script: choco install --no-progress msys2
            displayName: Install MSYS2
          - task: CacheBeta@1
            inputs:
              key: msys2_choco
              restoreKeys: msys2_choco
              path: $(CHOCO_CACHE)
            displayName: 'Cache msys2 choco install'
          - script: |
              pacman -Sy
              pacman --noconfirm -S pacman-mirrors
            workingDirectory: $(MSYS_BIN)
            displayName: Check pacman
          - script: | 
              pacman --noconfirm -S ^
                mingw-w64-x86_64-uasm ^
                mingw-w64-x86_64-clang ^
                mingw-w64-x86_64-lld ^
                mingw-w64-x86_64-ninja ^
                mingw-w64-x86_64-cmake
            workingDirectory: $(MSYS_BIN)
            displayName: 'Install requirements'
          - task: CacheBeta@1
            inputs:
              key: msys2
              restoreKeys: msys2
              path: $(MSYS2_CACHE)
            displayName: 'Cache msys2'
          - bash: |
              cmake \
                -GNinja \
                -Bbuild \
                -H. \
                -DCMAKE_C_FLAGS="-fuse-ld=lld -Wfatal-errors -Wall" \
                -DCMAKE_CXX_FLAGS="-fuse-ld=lld -Wfatal-errors -Wall" \
                -DCMAKE_C_COMPILER=clang \
                -DCMAKE_CXX_COMPILER=clang++
              cd build && ninja
            workingDirectory: $(Build.SourcesDirectory)
            displayName: Build
            failOnStderr: true
            env: {
              "PATH" : 'C:/tools/msys64/usr/bin;C:/tools/msys64/mingw64/bin'
            }